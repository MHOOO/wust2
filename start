#!/bin/bash -e

stage="$1"
compose_stage="$(dirname $0)/docker/compose"
compose="$compose_stage $stage"

case $stage in
test.postgres)
    $compose down
    $compose run db-migration
    $compose run test
    rc=$?
    $compose down
    exit $rc
    ;;
test.integration)
    $compose down
    $compose run db-migration
    $compose run test
    rc=$?
    $compose down
    exit $rc
    ;;
psql.docker)
    sbt dbMigration/docker
    $compose_stage dev up -d db-migration
    $compose_stage dev exec postgres psql -U dev
    ;;
psql)
    sbt dbMigration/docker
    $compose_stage dev run db-migration
    PGPASSWORD=dev psql -h localhost -U dev
    ;;
dev.docker)
    sbt dbMigration/docker
    $compose up -d db-migration
    $compose run --service-ports wust
    ;;
dev)
    sbt dbMigration/docker
    $compose up -d
    POSTGRES_HOSTNAME=localhost POSTGRES_DB=dev POSTGRES_USER=dev POSTGRES_PASSWORD=dev sbt dev
    ;;
prod.http)
    $compose up -d postgres
    $compose run db-migration
    $compose up -d
    ;;
prod)
    $compose up -d postgres
    $compose run db-migration
    $compose up -d
    ;;
*)
    echo "unknown stage '$1', expected one of [test.postgres,psql,psql.docker,dev,dev.docker,prod,prod.http]"
    exit 1
esac
