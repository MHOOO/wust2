#!/bin/bash -e

stage="$1"
compose_stage="$(dirname $0)/docker/compose"
compose="$compose_stage $stage"

case $stage in
test.postgres)
    $compose down
    $compose run db-migration
    $compose run test
    rc=$?
    $compose down
    exit $rc
    ;;
test.integration)
    $compose down
    $compose up -d
    sbt it:test
    rc=$?
    $compose down
    exit $rc
    ;;
psql)
    sbt dbMigration/docker
    $compose_stage dev run db-migration
    PGPASSWORD=dev psql -h localhost -U dev
    ;;
dev)
    sbt dbMigration/docker
    $compose up -d
    POSTGRES_HOSTNAME=localhost POSTGRES_DB=dev POSTGRES_USER=dev POSTGRES_PASSWORD=dev sbt
    ;;
prod.http)
    $compose up -d postgres
    $compose run db-migration
    $compose up -d
    ;;
prod)
    $compose up -d postgres
    $compose run db-migration
    $compose up -d
    ;;
*)
    echo "unknown stage '$1', expected one of [psql,dev,test.postgres,test.integration,prod.http,prod]"
    exit 1
esac
