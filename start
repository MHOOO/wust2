#!/bin/bash -e

stage="$1"
compose="$(dirname $0)/docker/compose $stage"

case $stage in
test.postgres)
    export POSTGRES_USER=test POSTGRES_PASSWORD=test
    sbt dbMigration/docker
    $compose down
    $compose run db-migration
    $compose run test
    rc=$?
    $compose down
    exit $rc
    ;;
dev.docker)
    export POSTGRES_USER=test POSTGRES_PASSWORD=test
    sbt dbMigration/docker
    $compose up -d db-migration
    $compose run --service-ports wust sbt dev
    ;;
dev)
    export POSTGRES_USER=test POSTGRES_PASSWORD=test
    sbt dbMigration/docker
    $compose up -d
    POSTGRES_HOSTNAME=localhost sbt dev
    ;;
prod.http)
    sbt docker
    $compose up -d postgres
    $compose run db-migration
    $compose up -d
    ;;
prod)
    sbt docker
    $compose up -d postgres
    $compose run db-migration
    $compose up -d
    ;;
*)
    echo "unknown stage '$1', expected one of [test,dev,local,prod.http,prod,prod.http]"
    exit 1
esac
