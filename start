#!/bin/bash -e

export POSTGRES_DB=${POSTGRES_DB:-'wust'} \
       POSTGRES_USER=${POSTGRES_USER:-'test'} \
       POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-'test'}

cmd="$(dirname $0)/docker/compose"

case $1 in
test)
    $cmd test down
    $cmd test up --build -d postgres
    $cmd test run test
    rc=$?
    $cmd test down
    exit $rc
    ;;
dev)
    $cmd dev down
    $cmd dev build wust
    $cmd dev run --service-ports wust sbt dev
    ;;
local)
    $cmd local down
    $cmd local up --build -d
    POSTGRES_HOSTNAME=localhost sbt dev
    ;;
prod)
    sbt backend/assembly
    $cmd prod down
    $cmd prod up --build -d
    ;;
*)
    echo "unknown stage '$1', expected one of [prod,local,dev]"
    exit 1
esac
