#!/bin/bash -e

export POSTGRES_DB=${POSTGRES_DB:-'wust'} \
       POSTGRES_USER=${POSTGRES_USER:-'test'} \
       POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-'test'}

stage="$1"
compose="$(dirname $0)/docker/compose $stage"

case $stage in
test.postgres)
    sbt dbMigration/docker
    $compose down
    $compose run db-migration
    $compose run test
    rc=$?
    $compose down
    exit $rc
    ;;
dev.docker)
    sbt dbMigration/docker
    $compose down
    $compose up -d db-migration
    $compose run --service-ports wust sbt dev
    ;;
dev)
    sbt dbMigration/docker
    $compose down
    $compose up -d
    POSTGRES_HOSTNAME=localhost sbt dev
    ;;
prod)
    sbt docker
    $compose up -d postgres
    $compose run db-migration
    $compose up
    ;;
*)
    echo "unknown stage '$1', expected one of [dev,dev.docker,test.postgres,prod]"
    exit 1
esac
