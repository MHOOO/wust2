#!/bin/bash -e

stage="$1"
compose_stage="$(dirname $0)/docker/compose"
compose="$compose_stage $stage"

case $stage in
test.postgres)
    export POSTGRES_USER=test POSTGRES_PASSWORD=test
    sbt dbMigration/docker
    $compose down
    $compose run db-migration
    $compose run test
    rc=$?
    $compose down
    exit $rc
    ;;
psql.docker)
    export POSTGRES_USER=test POSTGRES_PASSWORD=test
    sbt dbMigration/docker
    $compose_stage dev up -d db-migration
    $compose_stage dev exec postgres psql -U $POSTGRES_USER wust
    ;;
psql)
    export POSTGRES_USER=test POSTGRES_PASSWORD=test
    sbt dbMigration/docker
    $compose_stage dev run db-migration
    PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER wust
    ;;
dev.docker)
    export POSTGRES_USER=test POSTGRES_PASSWORD=test
    sbt dbMigration/docker
    $compose up -d db-migration
    $compose run --service-ports wust sbt dev
    ;;
dev)
    export POSTGRES_USER=test POSTGRES_PASSWORD=test
    sbt dbMigration/docker
    $compose up -d
    POSTGRES_HOSTNAME=localhost POSTGRES_DB=wust sbt dev
    ;;
prod.http)
    sbt docker
    $compose up -d postgres
    $compose run db-migration
    $compose up -d
    ;;
prod)
    sbt docker
    $compose up -d postgres
    $compose run db-migration
    $compose up -d
    ;;
*)
    echo "unknown stage '$1', expected one of [test,dev,dev.docker,psql,psql.docker,prod.http,prod,prod.http]"
    exit 1
esac
