#!/usr/bin/env bash
set -e
set -o pipefail

script_dir="$(dirname $(readlink -f '$0'))"

stage="$1"
compose_stage="$script_dir/docker/compose"
compose="$compose_stage $stage"

override_sbt_arg="$2"
function sbt_arg() {
    arg=$1
    [ -n "$override_sbt_arg" ] && arg="$override_sbt_arg"

    sbt $arg
}

case $stage in
psql)
    sbt dbMigration/docker
    $compose_stage dev run db-migration
    # PGPASSWORD=test psql -h localhost -U wust
    docker exec -it wustdev_postgres_1  psql -h localhost -U wust
    ;;
dev)
    sbt dbMigration/docker
    $compose up -d
    WUST_AUTH_SECRET=secret POSTGRES_HOSTNAME=localhost POSTGRES_DB=wust POSTGRES_USER=wust POSTGRES_PASSWORD=test sbt_arg
    ;;
prod.http)
    $compose pull
    $compose run db-migration
    $compose up -d --remove-orphans
    ;;
prod)
    $compose pull
    $compose run db-migration
    $compose up -d --remove-orphans
    ;;
test.postgres)
    $compose down
    $compose run db-migration
    $compose run test
    $compose down
    ;;
test.integration)
    $compose down
    $compose up -d
    # POSTGRES_POST 5431 for travis, as default port 5432 is already in use
    WUST_AUTH_SECRET=secret POSTGRES_HOSTNAME=localhost POSTGRES_DB=wust POSTGRES_USER=wust POSTGRES_PASSWORD=test POSTGRES_PORT=5431 sbt_arg it:test
    $compose down
    ;;
test.prod.http)
    export WUST_AUTH_SECRET=secret HOST_DOMAIN=localhost POSTGRES_PASSWORD=test
    $compose_stage prod.http down
    $compose_stage prod.http up -d
    sbt_arg systemTest/it:test
    $compose_stage prod.http down
    ;;
test.prod)
    export WUST_AUTH_SECRET=secret HOST_DOMAIN=localhost POSTGRES_PASSWORD=test CERT_DIR=$PWD/systemTest SSL_CERT=.test_cert.pem SSL_KEY=.test_key.pem
    $compose_stage prod down
    $compose_stage prod up -d
    #TODO sbt_arg systemTest/it:test
    nc -z localhost 80 && nc -z localhost 443
    $compose_stage prod down
    ;;
local.prod.http)
    export WUST_AUTH_SECRET=secret HOST_DOMAIN=localhost POSTGRES_PASSWORD=test
    $compose_stage prod.http down
    $compose_stage prod.http up -d
    ;;
local.prod)
    export WUST_AUTH_SECRET=secret HOST_DOMAIN=localhost POSTGRES_PASSWORD=test CERT_DIR=$PWD/systemTest SSL_CERT=.test_cert.pem SSL_KEY=.test_key.pem
    $compose_stage prod down
    $compose_stage prod up -d
    ;;
*)
    echo "unknown stage '$1', expected one of [psql,dev,prod.http,prod,test.postgres,test.integration,test.prod.http,test.prod,local.prod.http,local.prod]"
    exit 1
esac
