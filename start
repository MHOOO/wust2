#!/bin/bash
set -e
set -o pipefail

script_dir="$(dirname $(readlink -f '$0'))"
stage="$1"
compose_stage="$(dirname $0)/docker/compose"
compose="$compose_stage $stage"

case $stage in
psql)
    sbt dbMigration/docker
    $compose_stage dev run db-migration
    PGPASSWORD=test psql -h localhost -U wust
    ;;
dev)
    sbt dbMigration/docker
    $compose up -d
    POSTGRES_HOSTNAME=localhost POSTGRES_DB=wust POSTGRES_USER=wust POSTGRES_PASSWORD=test sbt
    ;;
prod.http)
    $compose pull
    $compose run db-migration
    $compose up -d --remove-orphans
    ;;
prod)
    $compose pull
    $compose run db-migration
    $compose up -d --remove-orphans
    ;;
test.postgres)
    $compose down
    $compose run db-migration
    $compose run test
    $compose down
    ;;
test.integration)
    $compose down
    $compose up -d
    POSTGRES_HOSTNAME=localhost POSTGRES_DB=wust POSTGRES_USER=wust POSTGRES_PASSWORD=test sbt it:test
    $compose down
    ;;
test.prod.http)
    export HOST_DOMAIN=localhost POSTGRES_PASSWORD=test
    $compose_stage prod.http down
    $compose_stage prod.http up -d
    sbt systemTest/it:test
    $compose_stage prod.http down
    ;;
test.prod)
    export HOST_DOMAIN=localhost POSTGRES_PASSWORD=test CERT_DIR=$PWD/systemTest SSL_CERT=.test_cert.pem SSL_KEY=.test_key.pem
    $compose_stage prod down
    $compose_stage prod up -d
    #TODO sbt systemTest/it:test
    nc -z localhost 80 && nc -z localhost 443
    $compose_stage prod down
    ;;
local.prod.http)
    export HOST_DOMAIN=localhost POSTGRES_PASSWORD=test
    $compose_stage prod.http down
    $compose_stage prod.http up -d
    ;;
local.prod)
    export HOST_DOMAIN=localhost POSTGRES_PASSWORD=test CERT_DIR=$PWD/systemTest SSL_CERT=.test_cert.pem SSL_KEY=.test_key.pem
    $compose_stage prod down
    $compose_stage prod up -d
    ;;
*)
    echo "unknown stage '$1', expected one of [psql,dev,prod.http,prod,test.postgres,test.integration,test.prod.http,test.prod,local.prod.http,local.prod]"
    exit 1
esac
